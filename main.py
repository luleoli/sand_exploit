from flask import Flask, render_template, request, flash, url_for, flash, redirect
import pandas as pd
import lightgbm as lgb
from sklearn.model_selection import train_test_split
from sklearn.metrics import roc_auc_score

def new_test(df, predictors, new_vars, target):
    train_df, val_df = train_test_split(df, test_size=0.15, random_state=1)

    mdl = lgb.LGBMClassifier(random_state=0)
    mdl.fit(train_df[predictors], train_df[target])

    ens_mdl = lgb.LGBMClassifier(random_state=0)
    ens_mdl.fit(train_df[predictors + new_vars], train_df[target])

    gini = 2*(roc_auc_score(val_df[target], mdl.predict_proba(val_df[predictors])[:, 1]))-1
    ens_gini = 2*(roc_auc_score(val_df[target], ens_mdl.predict_proba(val_df[predictors + new_vars])[:, 1]))-1
    return gini - ens_gini


app = Flask(__name__)
app.config['SECRET_KEY'] = 'lucas'

@app.route('/newtest', methods=['GET','POST'])
def newtest():
    if request.method == 'POST':
        bname = request.form.get('inputBname')
        oldvars = request.form.get('inputOldvars')
        newvars = request.form.get('inputNewvars')
        perf = request.form.get('inputPerf')
        if not bname:
            flash('Name is required!')
        elif not oldvars:
            flash('Old vars is required!')
        elif not newvars:
            flash('New vars is required!')
        elif not perf:
            flash('Performance is required!')
        else:
            lift = new_test(pd.read_csv(bname), list(oldvars.replace(" ","").split(",")), list(newvars.replace(" ","").split(",")), perf)
            print(lift) 
            return redirect(url_for('report'))
    return render_template('newtest.html')

@app.route('/report')
def report(): 
    return render_template('report.html')

if __name__ == '__main__':
    app.run(debug=True)


